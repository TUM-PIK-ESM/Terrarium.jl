<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Numerical core · Terrarium.jl</title><meta name="title" content="Numerical core · Terrarium.jl"/><meta property="og:title" content="Numerical core · Terrarium.jl"/><meta property="twitter:title" content="Numerical core · Terrarium.jl"/><meta name="description" content="Documentation for Terrarium.jl."/><meta property="og:description" content="Documentation for Terrarium.jl."/><meta property="twitter:description" content="Documentation for Terrarium.jl."/><meta property="og:url" content="https://tum-pik-esm.github.io/Terrarium.jl/stable/overview/numerical_core/"/><meta property="twitter:url" content="https://tum-pik-esm.github.io/Terrarium.jl/stable/overview/numerical_core/"/><link rel="canonical" href="https://tum-pik-esm.github.io/Terrarium.jl/stable/overview/numerical_core/"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Terrarium.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><input class="collapse-toggle" id="menuitem-2" type="checkbox" checked/><label class="tocitem" for="menuitem-2"><span class="docs-label">Overview</span><i class="docs-chevron"></i></label><ul class="collapsed"><li class="is-active"><a class="tocitem" href>Numerical core</a><ul class="internal"><li><a class="tocitem" href="#Grids"><span>Grids</span></a></li><li><a class="tocitem" href="#Fields"><span>Fields</span></a></li><li><a class="tocitem" href="#Parallel-programming-with-KernelAbstractions.jl"><span>Parallel programming with KernelAbstractions.jl</span></a></li><li><a class="tocitem" href="#Numeric-types"><span>Numeric types</span></a></li></ul></li><li><a class="tocitem" href="../software_architecture/">Software architecture</a></li><li><a class="tocitem" href="../mathematical_formulation/">Mathematical formulation</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox"/><label class="tocitem" for="menuitem-3"><span class="docs-label">Physics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-3-1" type="checkbox"/><label class="tocitem" for="menuitem-3-1"><span class="docs-label">Soil physics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../physics/soil_energy_water/">Energy and water balance</a></li></ul></li><li><a class="tocitem" href="../../physics/vegetation/">Vegetation</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox"/><label class="tocitem" for="menuitem-4"><span class="docs-label">Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../notebooks/examples_overview/">Overview</a></li><li><a class="tocitem" href="../../notebooks/example_model_notebook/">Model Interface</a></li></ul></li><li><a class="tocitem" href="../../contributing/">Contributing</a></li><li><a class="tocitem" href="../../api_reference/">API Reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Overview</a></li><li class="is-active"><a href>Numerical core</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Numerical core</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/TUM-PIK-ESM/Terrarium.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/TUM-PIK-ESM/Terrarium.jl/blob/main/docs/src/overview/numerical_core.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Numerical-core"><a class="docs-heading-anchor" href="#Numerical-core">Numerical core</a><a id="Numerical-core-1"></a><a class="docs-heading-anchor-permalink" href="#Numerical-core" title="Permalink"></a></h1><p>Terrarium is based on the numerics and finite-volume method (FVM) operators provided by <a href="https://github.com/CliMA/Oceananigans.jl">Oceananigans.jl</a>. All state variables are realized as Oceananigans <a href="https://clima.github.io/OceananigansDocumentation/stable/fields/"><code>Field</code>s</a> defined over a particular choice of <a href="https://clima.github.io/OceananigansDocumentation/stable/grids/">grid</a> which discretizes physical space into a finite number of <em>volumes</em> or &quot;cells&quot;. This page gives a brief overview of the basic concepts behind the numerical building blocks of Oceanangians and Terrarium.</p><h2 id="Grids"><a class="docs-heading-anchor" href="#Grids">Grids</a><a id="Grids-1"></a><a class="docs-heading-anchor-permalink" href="#Grids" title="Permalink"></a></h2><p>Terrarium defines its own <code>AbstractLandGrid</code> types as wrappers around Oceananigans <code>AbstractGrid</code> types (note that these wrappers may be consolidated into full-fledged <code>AbstractGrid</code>s in the future). At the moment, Terrarium grids are based primarily on the Oceanangians <code>RectilinearGrid</code>, which represents a rectangular volume divided orthogonally into smaller control volumes along orthogonal X, Y, and Z axes. There are currently two <code>AbstractLandGrid</code> implementations:</p><ul><li><a href="../../api_reference/#Terrarium.ColumnGrid"><code>ColumnGrid</code></a> which represents an unstructured collection of 1D vertical columns discretized along the <code>Z</code> axis with the <code>X</code> axis corresponding to a non-spatial index over each of those columns and the <code>Y</code> axis ignored (assigned a <code>Flat</code> grid &quot;topology&quot; in the underlying <code>RectilinearGrid</code>).</li><li><a href="../../api_reference/#Terrarium.ColumnRingGrid"><code>ColumnRingGrid</code></a> which is the same as <code>ColumnGrid</code> but with columns ordered according to a user-specified <code>RingGrid</code> from <a href="https://speedyweather.github.io/SpeedyWeatherDocumentation/stable/ringgrids/">RingGrids.jl</a>. Under this configuration, each dimension along the <code>X</code> axis corresponds to a point in the <code>RingGrid</code>, allowing for direct translation between Terrarium and RingGrids <code>Field</code>s. This is primarily motivated by our goal to couple Terrarium with <a href="https://github.com/SpeedyWeather/SpeedyWeather.jl">SpeedyWeather.jl</a>.</li></ul><p>All Terrarium <code>AbstractLandGrid</code> implementations are required to implement the following methods:</p><ul><li><code>architecture(grid)</code> (from Oceananigans) which returns the <code>Architecture</code> (e.g. <code>CPU</code> or <code>GPU</code>) on which the grid is defined,</li><li><code>get_field_grid(grid)</code> which returns the underlying <code>Oceananigans</code> grid.</li></ul><p>The vertical <code>Z</code>-axis is currently limited to representing the subsurface (typically soil) domain, though we plan to expand this to include snow and canopy layers in the future.</p><p>!!! info Ordering of vertical layers     Oceananigans follows a <strong>positive-upwards</strong> convention for the vertical axis. This also implies that the vertical layer at the first index of a 3D Terrarium field is actually the <strong>bottom-most layer</strong> in the ground/soil column; i.e. <code>interior(temperature)[1,1,1]</code> for a <code>Field</code> called <code>temperature</code> would correspond to the vertical layer at the bottom of the first grid cell (i.e. <code>X = 1</code>). To get the topmost layer, use instead <code>interior(temperature)[1,1,end]</code>. Note that here <a href="https://clima.github.io/OceananigansDocumentation/stable/appendix/library/#Oceananigans.Fields.interior-Tuple{Field}"><code>interior</code></a> is a function from Oceananigans that retrieves a view of the <code>Field</code> excluding halo (boundary condition) cells.</p><p>For more information on how Oceananigans grids work, we recommend reading the <a href="https://clima.github.io/OceananigansDocumentation/stable/grids/">corresponding page</a> in the Oceananigans documentation.</p><h2 id="Fields"><a class="docs-heading-anchor" href="#Fields">Fields</a><a id="Fields-1"></a><a class="docs-heading-anchor-permalink" href="#Fields" title="Permalink"></a></h2><p><code>Field</code>s define <code>Array</code>s of data that align with a grid. In Terrarium, <code>Field</code>s are used exclusively to represent state and input variables that vary in space (and time). All <code>Field</code>s have a corresponding <code>location(field) = (LX, LY, LZ)</code> which describes how the <code>Field</code> aligns with the underlying grid. Each of <code>LX</code>, <code>LY</code>, and <code>LZ</code> can take on values of either <code>Center</code>, <code>Face</code>, or <code>nothing</code>, where <code>Center</code> refers to the spatial centerpoint of the cell (representing the spatial average over that volume in the typical finite-volume sense) and <code>Face</code> corresponds to values defined at the interfaces such as fluxes or conductivities. A <code>nothing</code> location refers to a reduced quantity averaged or integrated over the corresponding axis.</p><p>In addition to holding data, <code>Field</code>s also can also store one or more associated <a href="https://clima.github.io/OceananigansDocumentation/stable/fields/#Halo-regions-and-boundary-conditions">boundary conditions</a> as well as &quot;halo&quot; regions used to define them. Boundary conditions can either be Dirichlet-type (<code>ValueBoundaryCondition</code>), Neumann-type (<code>GradientBoundaryCondition</code>), or fluxes (<code>FluxBoundaryCondition</code>). Boundary conditions can be defined using functions, scalars, <code>Array</code>s or other <code>Field</code>s.</p><p><code>Field</code>s can also serve as the basis for building <a href="https://clima.github.io/OceananigansDocumentation/stable/operations/">expression trees</a>: e.g. writing <code>C = A * B + 1</code> where <code>A</code> and <code>B</code> are both <code>Field</code>s results in a derived <code>Field</code> <code>C</code> that will lazily compute the expression when accessed. Similarly, <code>Fields</code> can be reduced over a grid axis using operations like <code>Integral</code> and <code>Average</code>, though these must be explciitly computed via <code>compute!</code>.</p><p>For a more detailed overview of <code>Field</code>s, we recommend checking out the <a href="https://clima.github.io/OceananigansDocumentation/stable/fields/">corresponding page</a> in the Oceananigans documentation.</p><h2 id="Parallel-programming-with-KernelAbstractions.jl"><a class="docs-heading-anchor" href="#Parallel-programming-with-KernelAbstractions.jl">Parallel programming with KernelAbstractions.jl</a><a id="Parallel-programming-with-KernelAbstractions.jl-1"></a><a class="docs-heading-anchor-permalink" href="#Parallel-programming-with-KernelAbstractions.jl" title="Permalink"></a></h2><p>Like Oceananigans and SpeedyWeather, the numerical core of Terrarium is based on <a href="https://github.com/JuliaGPU/KernelAbstractions.jl">KernelAbstractions.jl</a> which allows for device-agnostic <em>parallel programming</em> via computational <em>kernels</em>. The purpose of this design is to allow for highly efficient, scalable, and cross-architecture (e.g. CPU/GPU/TPU) parallelization of all numerical computations. Kernels are defined using the <code>@kernel</code> macro from KernelAbstractions:</p><pre><code class="language-julia hljs">@kernel function square_kernel!(output, input, other_args...)
    i, j, k = @index(Global, NTuple)
    output[i, j, k] = input[i, j, k]^2
end</code></pre><p>where <code>input</code> and <code>output</code> are here assumed to be 3D <code>Array</code>s or <code>Field</code>s. Note that kernels can also accept any arbitrary number of arguments of any plain data type (including immutable <code>struct</code>s) for which <code>isbits(arg)</code> is true.</p><p>Kernels represent self-contained programs that can be execute in parallel by large number of worker threads or processes. Intuitively, you can think of the kernel function as the body of a <code>for</code> loop that executes over all finite volumes defined on the grid. The <a href="https://juliagpu.github.io/KernelAbstractions.jl/stable/api/#KernelAbstractions.@index"><code>@index</code></a> macro extracts the index of the executing thread within the parallel kernel; <code>Global</code> here refers to the index across all workgroups (or &quot;blocks&quot; in CUDA language).</p><p>Terrarium and Oceananigans kernels are typically launched over a <code>grid</code> (or some subset thereof) via <code>launch!</code>,</p><pre><code class="language-julia hljs">launch!(architecture(grid), grid, :xyz, square_kernel!, output_field, input_field)</code></pre><p>where <code>:xyz</code> indicates the dimensions of the grid over which the kernel should be executed. For 2D (e.g. surface) computations, this would instead be <code>:xy</code>. In Terrarium, we typically use a slightly condensed variant of <code>launch!</code> for convenience:</p><pre><code class="language-julia hljs">launch!(grid, XYZ, square_kernel!, output_field, input_field)</code></pre><p>which automatically passes <code>grid</code> as the second argument to the kernel. Note that, in order to make use of this convenience dispatch of <code>launch!</code>, the above kernel would need to be modified to have the signature <code>square_kernel!(output, grid, input, other_args...)</code>. We generally find this convenient since it makes the kernel&#39;s dependence on the <code>grid</code> more explicit. However, it comes with a small amount of runtime overhead in cases where the <code>grid</code> is not needed. Note also the argument <code>XYZ</code> (or <code>XY</code> for 2D) corresponds to a <code>VarDims</code> type used to define Terrarium state variables; this syntax can be used interchangeably with the Oceananigans <code>Symbol</code> syntax.</p><div class="admonition is-warning" id="Warning-452b943ce4eb91ba"><header class="admonition-header">Warning<a class="admonition-anchor" href="#Warning-452b943ce4eb91ba" title="Permalink"></a></header><div class="admonition-body"><p>The kernel launching patterns used in Terrarium are still in an early stage of development and may change in the future.</p></div></div><h2 id="Numeric-types"><a class="docs-heading-anchor" href="#Numeric-types">Numeric types</a><a id="Numeric-types-1"></a><a class="docs-heading-anchor-permalink" href="#Numeric-types" title="Permalink"></a></h2><p>A common pattern that you may notice throughout the Terrarium codebase is the widespread use of the type argument <code>NF</code>. This stands for &quot;number format&quot; (in Oceananigans/ClimA it&#39;s usually called <code>FT</code> for &quot;floating-point type&quot;) and is usually set to either double-precision <code>Float64</code> or single-precision <code>Float32</code>, though lower precisions (or even non-<code>Float</code> types) are also theoretically possible. The widespread use of these type arguments is necessary to ensure (i) flexibility in the number format for all model parameters and state variables, and (ii) consistency throughout any given configuration of the model. We typically want to avoid the situation where some variables have type <code>Float64</code> and some have <code>Float32</code>, for example, since this can reuslt in errors and severe degradation of performance when running on GPU. As such, we typically require all parameter and configuration <code>struct</code>s to be defined following the pattern:</p><pre><code class="language-julia hljs">@kwdef struct SomeParameters{NF}
    a::NF = 1.0
    b::NF = 2.0
end</code></pre><p>with a constructor that accepts the numeric type as the first argument, e.g.</p><pre><code class="language-julia hljs">SomeParameters(::Type{NF}; kwargs...) where {NF} = SomeParameters{NF}(; kwargs...)</code></pre><p>or</p><pre><code class="language-julia hljs">SomeParameters(::Type{NF}; a::NF = 1.0, b::NF = 2.0) where {NF} = SomeParameters(a, b)</code></pre><p>In the latter case, the <code>@kwdef</code> macro on the <code>struct</code> definition may be omitted.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../">« Home</a><a class="docs-footer-nextpage" href="../software_architecture/">Software architecture »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.16.1 on <span class="colophon-date" title="Monday 16 February 2026 15:37">Monday 16 February 2026</span>. Using Julia version 1.11.9.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
